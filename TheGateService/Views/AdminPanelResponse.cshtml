@using System
@using System.Collections
@using System.Collections.Generic
@using System.Linq
@using TheGateService.Extensions
@using TheGateService.Types

@{
    ViewBag.Title = "Admin Panel";
    Layout = "MainLayoutNoSidebar";
}
<script type="text/javascript">
    $(document).ready(function () {
        $.tablesorter.addParser({
            id: 'booleans',
            is: function (b) {
                return false;
            },
            format: function (s) {
                return s.replace(/[Tt]rue/, 1).replace(/[Ff]alse/, 0);
            },
            type: 'numeric'
        });

        $('.product-table').tablesorter({
            //            debug   : true,
            headers: {
                5: { sorter: 'booleans' },
                6: { sorter: 'booleans' },
                7: { sorter: false }
            },
            cssHeader: 'updown',
            cssAsc: 'down',
            cssDesc: 'up'
        });

        $('.featured, .showcase').click(function (e) {
            // Get the numeric ID of the hidden label (in the format 'hidden-(featured|showcase)-{id}')
            var id = $(e.target).parent().children('[id]').attr('id').split('-')[2];
            switch (e.target.value.toLowerCase()) {
                case 'featured': $('#hidden-featured-'+id).text(e.target.checked); break;
                case 'showcase': $('#hidden-showcase-'+id).text(e.target.checked); break;
            }
            $('.product-table').trigger('update');

            // TODO: Update the product's featured/showcase status using AJAX call
        });
    });
</script>
<h1>All Products</h1>
<table class="table table-striped table-bordered product-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Featured</th>
            <th>Showcase</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (Product p in @Model.Results) {
            <tr id="product-@p.Id">
                <td class="product-id">@p.Id</td>
                <td class="product-name">@p.Name</td>
                <td class="product-desc" title="@p.Description">@p.Description.LimitWords(30)</td>
                <td class="product-price">$@p.Price</td>
                <td class="product-quantity">@p.Quantity</td>
                @* The two spans with class "hide" are used with the jQuery sorting plugin seen above. *@
                <td class="product-featured">
                    <label>
                        <input type="checkbox" class="checkbox featured" @(p.Featured ? "checked" : "") value="Featured"/>
                        <span id="hidden-featured-@(p.Id)" class="hide">@p.Featured</span>
                    </label>
                </td>
                <td class="product-showcase">
                    <label>
                        <input type="checkbox" class="checkbox showcase" @(p.Showcase ? "checked" : "") value="Showcase"/>
                        <span id="hidden-showcase-@(p.Id)" class="hide">@p.Showcase</span>
                    </label>
                </td>
                <td>
                    <input class="btn edit-button" 
                           type="button" 
                           value="Edit" />
                </td>
                <td>
                    <input class="btn btn-danger delete-button" 
                           type="button" 
                           value="Delete" />
                </td>
            </tr>
        }
    </tbody>
</table>
<div id="edit-modal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Editing <span id="modal-header-product-name"></span> <i class="icon-asterisk" style="display: none;" id="unsaved-indicator"></i></h3>
    </div>
    <div class="modal-body">
        <form id="product-form" class="form-horizontal">
            <div class="control-group">
                <label class="control-label">Name</label>
                <div class="controls">
                    <input type="text" id="modal-product-name" placeholder="Product Name"/>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">Description</label>
                <div class="controls">
                    <textarea id="modal-product-desc" rows="5" placeholder="Description"></textarea>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">Price</label>
                <div class="controls input-prepend" style="margin-top: -50px;">
                    <span class="add-on">$</span>
                    <input type="text" id="modal-product-price" placeholder="Product Price" style="width: 180px;"/>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">Quantity</label>
                <div class="controls">
                    <input type="number" id="modal-product-quantity" placeholder="Product Quantity"/>
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
                    <label class="checkbox">
                        <input id="modal-product-featured" type="checkbox"/> Featured
                    </label>
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
                    <label class="checkbox">
                        <input id="modal-product-showcase" type="checkbox"/> Showcase
                    </label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="javascript:void(0)" class="btn" data-dismiss="modal">Cancel</a>
        <a href="javascript:void(0)" class="btn btn-primary">Save Changes</a>
    </div>
</div>
<script type="text/javascript">
    // Globals
    var modified = {
        id: false,
        name: false,
        desc: false,
        price: false,
        quantity: false,
        featured: false,
        showcase: false,
    };

    function getProductFromRow(id) {
        var prefix = '#product-' + id + ' ';
        var product = {
            id: id,
            name: $(prefix + '.product-name').text(),
            desc: $(prefix + '.product-desc').attr('title'),
            price: parseFloat($(prefix + '.product-price').text().substr(1)), // remove the leading $
            quantity: parseInt($(prefix + '.product-quantity').text()),
            featured: $(prefix + '.product-featured input').is(':checked'),
            showcase: $(prefix + '.product-showcase input').is(':checked'),
        };

        return product;
    }

    function getProductFromForm() {
        var product = {
            id: getOriginalProduct().id,
            name: $('#modal-product-name').text(),
            desc: $('#modal-product-desc').text(),
            price: parseFloat($('#modal-product-price').val()), 
            quantity: parseInt($('#modal-product-quantity').val()),
            featured: $('#modal-product-featured').is(':checked'),
            showcase: $('#modal-product-showcase').is(':checked'),
        };
        return product;
    }

    function hasProductBeenEdited() {
        for (var property in modified) {
            if ($(modified).prop(property)) return true;
        }
        return false;
    }

    function getOriginalProduct() {
        return $('#edit-modal').data('product-original-value');
    }

    $(document).ready(function() {
        $('.edit-button').click(function() {
            // Get the product ID, which is stored in the parent <tr> attribute in the format "product-{id}"
            var id = $(this).closest('tr').attr('id').split('-')[1];
            var product = getProductFromRow(id);

            // Insert the product values
            $('#modal-header-product-name').text(product.name);
            $('#modal-product-name').val(product.name).data('name', product.name);
            $('#modal-product-desc').text(product.desc).data('desc', product.desc);
            $('#modal-product-price').val(product.price).data('price', product.price);
            $('#modal-product-quantity').val(product.quantity).data('quantity', product.quantity);
            $('#modal-product-featured').prop('checked', product.featured).data('featured', product.featured);
            $('#modal-product-showcase').prop('checked', product.showcase).data('showcase', product.showcase);

            $('#product-form input, #product-form textarea').change(function(e) {
                var prop = $(this).attr('id').split('-')[2];
                var value;                
                if (/text(area)?|number/.test(e.target.type)) { // Regex check for 'text', 'textarea', or 'number'
                    value = e.target.value;
                } else if (e.target.type == 'checkbox') {
                    value = $(e.target).is(':checked');
                }

                if(value !== undefined) $(this).data(prop, value);

                if ($(getOriginalProduct()).prop(prop) != $(this).data(prop)) {
                    $(modified).prop(prop, true);

                } else {
                    $(modified).prop(prop, false);
                }
                
                if (hasProductBeenEdited()) {
                    $('#edit-modal').modal('lock');
                    $('#unsaved-indicator').show();
                } else {
                    $('#edit-modal').modal('unlock');
                    $('#unsaved-indicator').hide();
                }
            });

            $('#edit-modal')
                // Save the original value, which will be used later to check if the product has not been saved
                .data('product-original-value', product)
                .modal('show')
                .on('hidePrevented', function() {
                    if (!hasProductBeenEdited()) return;
                    if (confirm('You have unsaved changes on "' + product.name + '". Are you sure you want to stop editing?')) {
                        $('#edit-modal')
                            .modal('unlock') // First unlock the modal so it can be hidden
                            .modal('hide'); // then hide it
                    }
                }).on('hide', function() {
                    // Unbind any events we bound, to prevent "stacking" of handlers
                    $('#product-form input, #product-form textarea').unbind('change');
                    $('#edit-modal').unbind('hidePrevented').unbind('hide');
                    $('#product-form')[0].reset();
                });
        });
    });
</script>